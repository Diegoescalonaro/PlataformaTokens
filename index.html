<!DOCTYPE html>

<html>

	<head>
  		<meta charset="utf-8">
  		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  		<!-- Importar nuestro ABI en el proyecto -->

      <script src="./node_modules/@waves/waves-api/dist/waves-api.min.js"></script>

      <!--<script src="./node_modules/@waves/waves-api/dist/waves-api.js"></script>-->

      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
      <!-- Google Fonts -->
	  <link href="https://fonts.googleapis.com/css?family=Bevan|Spectral|Francois+One|Righteou" rel="stylesheet">

      
      <script src="./dist/waves-signature-generator.js"></script>

      <script>
        const Waves = WavesAPI.create(WavesAPI.MAINNET_CONFIG);
        
        console.log(Waves);

      </script>

  		<title> Plataforma Tokens </title>

	</head>

	<body style="background-color: white; text-align:center; font-family: 'Spectral', serif;">

	  <!-- --- BARRA HORIZONTAL NAVEGADOR --- -->
      <nav class="nav navbar-default bg-dark">
          <div class="container-fluid" style="text-align:left">
          <div class="navbar-header">
              <a class="navbar-brand" href="index.html">TEFTOK</a>
            <a class="text-white">   Blockchain Competence Center</a>
            </div>
            <ul class="nav justify-content-center" style="font-family:'Bevan', cursive;">
                <li> <a class="nav-link text-white text-left" href="index.html">Index</a></a></li>
                <li> <a class="nav-link text-white" href="ganoTokens.html">Gano</a></li>
                <li> <a class="nav-link text-white" href="gastoTokens.html">Canjeables</a></li>
                <li> <a class="nav-link text-white text-right" href="intercambio.html">Intercambio</a> </li>
                <li style="position:absolute; right:20px; top:20px; background-color:white; border-radius:5%;"><a class="nav-link" style="font-family:'Francois One', sans-serif; font-size:120%;" id="balanceTEFTOK">  0 TEFTOK </a> </li>
            </ul>
          </div>
      </nav>
      <!-- --- FIN BARRA HORIZONTAL NAVEGADOR --- -->


    <!--  - - - - - - - - CONTAINER PRINCIPAL - - - - - - - - - - - - - -   -->
    <div class="container-fluid">

    	<div class="jumbotron">
     		<h1 style="font-style: oblique;"> <strong>PLATAFORMA DE TOKENS </strong></h1>
     		<p> Gana, canjea e intercambia Telef√≥nica Tokens interactuando con las distintas secciones de la plataforma web. </p>
    	</div>
      
    	<div class="bg-secundary ">
          	<hr>
          	<h1> - Login -  </h1>
          	<br>
      	</div>

      <!-- Formulario de Seed para login -->
      <p>Introduce tu Seed:</p> 
      <input id="seed" style="width:600px;"> </input>
      <button onclick="login()"> Acceder </button>

      <hr>
      
      <!-- - - - - - - - - - - MODAL OCULTO - - - - - - - - - - - - - - - -->
      <div id="modaloculto" class="invisible">

      	<!-- Informacion vinculada a la cuenta segun el Seed introducido en login -->
      	<h3> Informacion de cuenta </h3>
      	<div>
        	<p id="info"> </p>
        	<p id="transacciones"> </p>
      	</div>

      	<hr>

      	<button onclick="envio()"> PAGAR  </button>

      	<br><br><br>
      	<form action="./../Scriptswaves/envioTokens.py"> 

        	<input type=text name="opcion"> <br> </input>
        	<input type=submit value="Enviar tokens a esta direccion">  </input>

      	</form>

    	<br>

	</div>
    <!-- - - - - - - - - - - FIN MODAL OCULTO - - - - - - - - - - - - - - - -->

    </div class="container-fluid">
	<!--  - - - - - - - - FIN CONTAINER PRINCIPAL - - - - - - - - - - - - - -   -->





    <div class="bg-light rounded border"> 
    		<p> . . . </p>
          <h1>  Footer   </h1>
    </div>




		  <!-- Se ponen aqui los js y asi reduce el tiempo de carga del HTML -->
  		<script>

        var account = null;

        function login(){



          // Restaura cuenta desde Seed y guarda en sessionStorage
          account = Waves.Seed.fromExistingPhrase(document.getElementById("seed").value);
          console.log("Se ha iniciado sesion en:"+account.address);
          // Lo guardo en variable local del navegador (cookies)
          sessionStorage.setItem("Account",account);
          

          var info = document.getElementById("info");
          var transacciones = document.getElementById("transacciones");
          var balanceTEFTOK = document.getElementById("balanceTEFTOK");

          info.innerHTML = "<li><b>Direccion: </b>" +account.address +"<br></li>";
          transacciones.innerHTML = "";
          
          Waves.API.Node.addresses.balance(account.address)
            .then((PromiseValue) => {
            console.log("Balance Waves: "+PromiseValue.balance);
            info.innerHTML += "<li><b> Waves: </b>"+PromiseValue.balance+"<br></li>";
          });

         Waves.API.Node.assets.balance(account.address,"AFUG6HXViGfAnobd41H1sAeASUEmjF7dHsgt5K1XFcfM").then((value) => {
            console.log("Balance TEFTOK: "+value.balance/1000);
            sessionStorage.setItem("Balance",value.balance);
            balanceTEFTOK.innerHTML = sessionStorage.getItem("Balance")/1000+" TEFTOK";

            info.innerHTML += "<li><b> TEFTOK: </b>"+value.balance/1000+"<br></li>";
          });




          Waves.API.Node.transactions.getList(account.address,100).then((txs) => {
            console.log(txs);
            transacciones.innerHTML += "<hr>Ultimas Transacciones <br>";
            for(i=0; i<9; i++){
              transacciones.innerHTML += ""+txs[i].id+"<br>";
            }
          });
        
        }


        var transferData={};

        function envio(){


			console.log(Waves.config.get());

          	var timestamp1 = Date.now();

            	transferData = {
            	// An arbitrary address; mine, in this example
            	recipient: '3P6onwAhnS1e63sFjN2PCKuRsxdHJuF6Qna',
            
            	// ID of a token, or WAVES
            	assetId: 'AFUG6HXViGfAnobd41H1sAeASUEmjF7dHsgt5K1XFcfM', //TEFTOK
            	// The real amount is the given number divided by 10^(precision of the token)
            	amount: 1000,
            	// The same rules for these two fields
            	feeAssetId: 'WAVES',
            	fee: 100000,
            	// 140 bytes of data (it's allowed to use Uint8Array here)
            	attachment: '',
            	version:1,
            	timestamp: timestamp1
          	}; 

         	console.log(transferData);

         	Waves.API.Node.transactions.broadcast('transfer', transferData, account.keyPair).then((responseData) => {
            console.log(responseData);
          	});

/*
          getSignature();

          transferData = {
            // An arbitrary address; mine, in this example
            recipient: '3P6onwAhnS1e63sFjN2PCKuRsxdHJuF6Qna',
            senderPublicKey: "UiJxp3iR8AcCYVxaijFQbbGL2Hp4MSBPge6emBfqCEs",
            // ID of a token, or WAVES
            assetId: 'AFUG6HXViGfAnobd41H1sAeASUEmjF7dHsgt5K1XFcfM', //TEFTOK
            // The real amount is the given number divided by 10^(precision of the token)
            amount: 1000,
            // The same rules for these two fields
            feeAssetId: "",
            fee: 100000,
            // 140 bytes of data (it's allowed to use Uint8Array here)
            attachment: 'Probando',
            timestamp: timestamp1,
            signature: signature

          };

          /*transferData = { assetId: "AFUG6HXViGfAnobd41H1sAeASUEmjF7dHsgt5K1XFcfM", feeAssetId: "", senderPublicKey: "UiJxp3iR8AcCYVxaijFQbbGL2Hp4MSBPge6emBfqCEs", recipient: "3P6onwAhnS1e63sFjN2PCKuRsxdHJuF6Qna", amount: 1000, fee: 100000, timestamp: 1532419918476, attachment: "ETSLMqFmwRg", signature: "2E54gAosSAM2eRmjvfErXspHk6SLfY4CxbsHE97AyeU7WbFmoQ9hxboCZXVLobbuedhaYsPJxxZcCrtrt6QidSHE"} */


          /*fetch("https://nodes.wavesnodes.com/assets/broadcast/transfer",
              {
              headers:{
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                    },
              method: "POST",
              body: transferData
              })
              .then((response) => {
                  console.log(response);
                })
              .catch((error) => {
                  console.log(error);
                });
              
            var http = new XMLHttpRequest();
            var url = "https://nodes.wavesnodes.com/transactions/broadcast";
            http.open("POST",url,true);
            http.setRequestHeader("Content-Type", "application/json");
            
            http.onreadystatechange = function() {
              if(http.readyState == 4 && http.status == 200) { 
              //aqui obtienes la respuesta de tu peticion
            alert(http.responseText);
            }
              }
            http.send(transferData);
		*/

            
        }


        var ret="";

        function JSONToArray(json){ 
              var str = JSON.stringify(json, null, 0);
              ret = new Uint8Array(str.length);
              for (var i = 0; i < str.length; i++) {
                  ret[i] = str.charCodeAt(i);
              }
              return ret;
          }


        var signature = "";
        function getSignature(){

          JSONToArray(transferData);
          signature = wavesSignatureGenerator.utils.crypto.buildTransactionSignature(ret, account.keyPair.privateKey);
          console.log(signature);
        }

        //https://nodes.wavesnodes.com

  		</script>
  		<!-- Incluir jquery y bootstrap -->
  		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  
	</body>
</html>